<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Home Kit配对协议 | ExampleSite</title>
<meta name=keywords content><meta name=description content="SRP协议 SRP 是一种基于密码的相互身份验证的协议，要求双方都知道用户的密码。在身份验证过程中还生成了共享密钥，可通过对称加密来加密报文。
约定解释 N A large safe prime (N = 2q+1, where q is prime)，All arithmetic is done modulo N. g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s User's salt I Username p Cleartext Password H() One-way hash function ^ (Modular) Exponentiation u Random scrambling parameter a,b Secret ephemeral values A,B Public ephemeral values x Private key (derived from p and s) v Password verifier N 安全的大素数，所有的运算都是mod N g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s 加盐，是一种随机产生的数据，用于保护密码的安全 I 用户名 p 明文密码 H() 单向哈希函数，不可逆 ^ 模幂运算，即求a^b mod n的值 u 随机混淆参数，用于增加安全性 a,b 秘密临时值，是随机生成的大整数 A,B 公开临时值，用于身份验证的过程中 x 私钥，由密码p和盐值s衍生而来 v 密码验证器，由g^x mod N计算得出，用于在服务器端验证用户的密码 生成和存储Password Verifier 通过以下公式生成password verifier，服务端将{I, s, v}存储到数据库，可通过索引键I获取该三元组。"><meta name=author content="Xin"><link rel=canonical href=https://examplesite.com/posts/home-kit-paring/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://examplesite.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://examplesite.com/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://examplesite.com/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://examplesite.com/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://examplesite.com/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://examplesite.com/posts/home-kit-paring/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css integrity=sha384-wcIxkf4k558AjM3Yz3BBFQUbk/zgIYC2R0QpeeYb+TwlBVMrlgLqwRjRtGZiK7ww crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js integrity=sha384-hIoBPJpTUs74ddyc4bFZSM1TVlQDA60VBbJS0oA934VSz82sBx1X7kSx2ATBDIyd crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js integrity=sha384-43gviWU0YVjaDtb/GhzOouOXtZMP/7XUzwPTstBeZFe/+rCMvRwr4yROQP43s0Xk crossorigin=anonymous></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],throwOnError:!1})})</script><meta property="og:title" content="Home Kit配对协议"><meta property="og:description" content="SRP协议 SRP 是一种基于密码的相互身份验证的协议，要求双方都知道用户的密码。在身份验证过程中还生成了共享密钥，可通过对称加密来加密报文。
约定解释 N A large safe prime (N = 2q+1, where q is prime)，All arithmetic is done modulo N. g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s User's salt I Username p Cleartext Password H() One-way hash function ^ (Modular) Exponentiation u Random scrambling parameter a,b Secret ephemeral values A,B Public ephemeral values x Private key (derived from p and s) v Password verifier N 安全的大素数，所有的运算都是mod N g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s 加盐，是一种随机产生的数据，用于保护密码的安全 I 用户名 p 明文密码 H() 单向哈希函数，不可逆 ^ 模幂运算，即求a^b mod n的值 u 随机混淆参数，用于增加安全性 a,b 秘密临时值，是随机生成的大整数 A,B 公开临时值，用于身份验证的过程中 x 私钥，由密码p和盐值s衍生而来 v 密码验证器，由g^x mod N计算得出，用于在服务器端验证用户的密码 生成和存储Password Verifier 通过以下公式生成password verifier，服务端将{I, s, v}存储到数据库，可通过索引键I获取该三元组。"><meta property="og:type" content="article"><meta property="og:url" content="https://examplesite.com/posts/home-kit-paring/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-27T11:16:11+08:00"><meta property="article:modified_time" content="2024-04-27T11:16:11+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Home Kit配对协议"><meta name=twitter:description content="SRP协议 SRP 是一种基于密码的相互身份验证的协议，要求双方都知道用户的密码。在身份验证过程中还生成了共享密钥，可通过对称加密来加密报文。
约定解释 N A large safe prime (N = 2q+1, where q is prime)，All arithmetic is done modulo N. g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s User's salt I Username p Cleartext Password H() One-way hash function ^ (Modular) Exponentiation u Random scrambling parameter a,b Secret ephemeral values A,B Public ephemeral values x Private key (derived from p and s) v Password verifier N 安全的大素数，所有的运算都是mod N g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s 加盐，是一种随机产生的数据，用于保护密码的安全 I 用户名 p 明文密码 H() 单向哈希函数，不可逆 ^ 模幂运算，即求a^b mod n的值 u 随机混淆参数，用于增加安全性 a,b 秘密临时值，是随机生成的大整数 A,B 公开临时值，用于身份验证的过程中 x 私钥，由密码p和盐值s衍生而来 v 密码验证器，由g^x mod N计算得出，用于在服务器端验证用户的密码 生成和存储Password Verifier 通过以下公式生成password verifier，服务端将{I, s, v}存储到数据库，可通过索引键I获取该三元组。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://examplesite.com/posts/"},{"@type":"ListItem","position":2,"name":"Home Kit配对协议","item":"https://examplesite.com/posts/home-kit-paring/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Home Kit配对协议","name":"Home Kit配对协议","description":"SRP协议 SRP 是一种基于密码的相互身份验证的协议，要求双方都知道用户的密码。在身份验证过程中还生成了共享密钥，可通过对称加密来加密报文。\n约定解释 N A large safe prime (N = 2q+1, where q is prime)，All arithmetic is done modulo N. g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s User\u0026#39;s salt I Username p Cleartext Password H() One-way hash function ^ (Modular) Exponentiation u Random scrambling parameter a,b Secret ephemeral values A,B Public ephemeral values x Private key (derived from p and s) v Password verifier N 安全的大素数，所有的运算都是mod N g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s 加盐，是一种随机产生的数据，用于保护密码的安全 I 用户名 p 明文密码 H() 单向哈希函数，不可逆 ^ 模幂运算，即求a^b mod n的值 u 随机混淆参数，用于增加安全性 a,b 秘密临时值，是随机生成的大整数 A,B 公开临时值，用于身份验证的过程中 x 私钥，由密码p和盐值s衍生而来 v 密码验证器，由g^x mod N计算得出，用于在服务器端验证用户的密码 生成和存储Password Verifier 通过以下公式生成password verifier，服务端将{I, s, v}存储到数据库，可通过索引键I获取该三元组。","keywords":[],"articleBody":"SRP协议 SRP 是一种基于密码的相互身份验证的协议，要求双方都知道用户的密码。在身份验证过程中还生成了共享密钥，可通过对称加密来加密报文。\n约定解释 N A large safe prime (N = 2q+1, where q is prime)，All arithmetic is done modulo N. g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s User's salt I Username p Cleartext Password H() One-way hash function ^ (Modular) Exponentiation u Random scrambling parameter a,b Secret ephemeral values A,B Public ephemeral values x Private key (derived from p and s) v Password verifier N 安全的大素数，所有的运算都是mod N g A generator modulo N k Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6) s 加盐，是一种随机产生的数据，用于保护密码的安全 I 用户名 p 明文密码 H() 单向哈希函数，不可逆 ^ 模幂运算，即求a^b mod n的值 u 随机混淆参数，用于增加安全性 a,b 秘密临时值，是随机生成的大整数 A,B 公开临时值，用于身份验证的过程中 x 私钥，由密码p和盐值s衍生而来 v 密码验证器，由g^x mod N计算得出，用于在服务器端验证用户的密码 生成和存储Password Verifier 通过以下公式生成password verifier，服务端将{I, s, v}存储到数据库，可通过索引键I获取该三元组。\ns = randomsalt() (same length as N) I = H(I) p = H(p) (hash/expand I \u0026 p) t = H(I, \":\", p) x = H(s, t) v = g^x (computes password verifier) 身份认证过程 Client Server -------------- ---------------- un, pw = \u003c user input \u003e I = H(un) p = H(pw) a = random() A = g^a % N I, A --\u003e s, v = lookup(I) b = random() B = (kv + g^b) % N u = H(A, B) S = ((A * v^u) ^ b) % N K = H(S) M' = H(K, A, B, I, s, N, g) \u003c-- s, B u = H(A, B) x = H(s, p) S = ((B - k (g^x)) ^ (a + ux)) % N K = H(S) M = H(K, A, B, I, s, N, g) M --\u003e M must be equal to M' Z = H(M, K) \u003c-- Z Z' = H(M, K) Z' must equal Z 当服务器收到，其中I是用户名，A是用户生成的公开临时值，服务器就可以生成共享密钥和生成证明M’。共享密钥K的生成需要password verifier。\n生成证明：服务器和客户端都要计算一个值M，这个值是基于用户名、盐值、临时公开值和共享密钥等参数的哈希。服务器计算的值被称为M’。服务器通过验证M和M’是否相等，验证客户端是否生成和服务器一样的共享密钥，从而验证了客户端的身份，并生成证明Z给客户端，同理客户端通过验证Z和Z’是否相等，验证了服务器身份。\npackage main import ( \"crypto/subtle\" \"fmt\" \"github.com/opencoff/go-srp\" ) func main() { bits := 1024 pass := []byte(\"password string that's too long\") i := []byte(\"foouser\") s, err := srp.New(bits) if err != nil { panic(err) } v, err := s.Verifier(i, pass) if err != nil { panic(err) } ih, vh := v.Encode() // Store ih, vh in durable storage fmt.Printf(\"Verifier Store:\\n %s =\u003e %s\\n\", ih, vh) c, err := s.NewClient(i, pass) if err != nil { panic(err) } // client credentials (public key and identity) to send to server creds := c.Credentials() fmt.Printf(\"Client Begin; --\u003e server:\\n %s\\n\", creds) // Begin the server by parsing the client public key and identity. ih, A, err := srp.ServerBegin(creds) if err != nil { panic(err) } // Now, pretend to lookup the user db using \"I\" as the key and // fetch salt, verifier etc. s, v, err = srp.MakeSRPVerifier(vh) if err != nil { panic(err) } fmt.Printf(\"Server Begin; :\\n %s\\n %x\\n\", vh, A.Bytes()) srv, err := s.NewServer(v, A) if err != nil { panic(err) } // Generate the credentials to send to client creds = srv.Credentials() // Send the server public key and salt to server fmt.Printf(\"Server Begin; --\u003e client:\\n %s\\n\", creds) // client processes the server creds and generates // a mutual authenticator; the authenticator is sent // to the server as proof that the client derived its keys. cauth, err := c.Generate(creds) if err != nil { panic(err) } fmt.Printf(\"Client Authenticator: M --\u003e Server\\n %s\\n\", cauth) // Receive the proof of authentication from client proof, ok := srv.ClientOk(cauth) if !ok { panic(\"client auth failed\") } // Send proof to the client fmt.Printf(\"Server Authenticator: Z --\u003e Client\\n %s\\n\", proof) // Verify the server's proof if !c.ServerOk(proof) { panic(\"server auth failed\") } // Now, we have successfully authenticated the client to the // server and vice versa. kc := c.RawKey() ks := srv.RawKey() if 1 != subtle.ConstantTimeCompare(kc, ks) { panic(\"Keys are different!\") } fmt.Printf(\"Client Key: %x\\nServer Key: %x\\n\", kc, ks) } a\nVerifier Store: b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8 =\u003e 128:eeaf0ab9adb38dd69c33f80afa8fc5e86072618775ff3c0b9ea2314c9c256576d674df7496ea81d3383b4813d692c6e0e0d5d8e250b98be48e495c1d6089dad15dc7d7b46154d6b6ce8ef4ad69b15d4982559b297bcf1885c529f566660e57ec68edbc3c05726cc02fd4cbf4976eaa9afd5138fe8376435b9fc61d2fc0eb06e3:2:17:b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8:19a5dd80011dc63a3dfda1c742d55399c009617987868a6951ea91d754d7d9519a3c4801ec0da71eb4ae1cf3f0f97c857954a4d8f54729170512312819c790296b12c84c28bbe270f542c89c6446591373d3fea8ff445a51cefe85d002ce32e1fb003c5533d6b97f1464680c88afd4cc9e15ce15163a410be44b1af9c5e08265:a7d956665ae1415b380db321bcca75f013bda5ea347489318d2c967d1b69e4115c54022225e67e5008fdfcf0841feeb5a0e26fabdb6f0e05b3fc9f96f6b830ab1599ae1b22cbc31cd9b667b48ef0a33d580e43999b2299c8acb0ec761cb72558cf2cf8a7bad78a5b5bbb8a2c473d2f93e13975618b54a431a38344d779ddb7e6 Client Begin; --\u003e server: b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8:1588ca95bcc97f38c88f5cc942712e27867e71f7e33c25d53e17142170152d0f03420a3d17f23e9451c335b713bb5143bc7c8f398239a923dacf5d186dd49902e01e6bd7fb14c46d0d41d0e328711e3182b2d86ccd9151db6555bbdd9aa5f5e7df655d3c910c1e2d3527463b4b5932693291eae189446416534b1afe77773916 Server Begin; : 128:eeaf0ab9adb38dd69c33f80afa8fc5e86072618775ff3c0b9ea2314c9c256576d674df7496ea81d3383b4813d692c6e0e0d5d8e250b98be48e495c1d6089dad15dc7d7b46154d6b6ce8ef4ad69b15d4982559b297bcf1885c529f566660e57ec68edbc3c05726cc02fd4cbf4976eaa9afd5138fe8376435b9fc61d2fc0eb06e3:2:17:b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8:19a5dd80011dc63a3dfda1c742d55399c009617987868a6951ea91d754d7d9519a3c4801ec0da71eb4ae1cf3f0f97c857954a4d8f54729170512312819c790296b12c84c28bbe270f542c89c6446591373d3fea8ff445a51cefe85d002ce32e1fb003c5533d6b97f1464680c88afd4cc9e15ce15163a410be44b1af9c5e08265:a7d956665ae1415b380db321bcca75f013bda5ea347489318d2c967d1b69e4115c54022225e67e5008fdfcf0841feeb5a0e26fabdb6f0e05b3fc9f96f6b830ab1599ae1b22cbc31cd9b667b48ef0a33d580e43999b2299c8acb0ec761cb72558cf2cf8a7bad78a5b5bbb8a2c473d2f93e13975618b54a431a38344d779ddb7e6 1588ca95bcc97f38c88f5cc942712e27867e71f7e33c25d53e17142170152d0f03420a3d17f23e9451c335b713bb5143bc7c8f398239a923dacf5d186dd49902e01e6bd7fb14c46d0d41d0e328711e3182b2d86ccd9151db6555bbdd9aa5f5e7df655d3c910c1e2d3527463b4b5932693291eae189446416534b1afe77773916 Server Begin; --\u003e client: 19a5dd80011dc63a3dfda1c742d55399c009617987868a6951ea91d754d7d9519a3c4801ec0da71eb4ae1cf3f0f97c857954a4d8f54729170512312819c790296b12c84c28bbe270f542c89c6446591373d3fea8ff445a51cefe85d002ce32e1fb003c5533d6b97f1464680c88afd4cc9e15ce15163a410be44b1af9c5e08265:c19dda117838c7635838cfb9fe6a989f7b897a28b37a931fb1705a0e2dc2c81f2b6848a0e729522328cb273ed1abc676f4edb46a113ea9f8933088ffa59682115c4a945ee199516f5f239bfb7df2bcde6b9d704079cd5144bc4adfbaec472995c36f93cdebf24b7e3dc0cfcb21888921e0582fec28da77e07c0dfc7b7ebb57ad Client Authenticator: M --\u003e Server 201592da93ce191af56559836f9fa3960016f0b137b2bde4164692febb9fcdaf Server Authenticator: Z --\u003e Client cdb200ca5280baedff73efb4b4078b411bd6caf4b0456793b2a489ee16cbc2aa Client Key: a13788fbd82def1995bf1057b32d6ea2c31a25ce056c1edb3bf766ce18ac09d6 Server Key: a13788fbd82def1995bf1057b32d6ea2c31a25ce056c1edb3bf766ce18ac09d6 Home Kit配对 home kit配对使用SRP协议，username和password为“Pair‐Setup”和setup code。\n配对流程 iOS device/srp client Accessory/srp server -------------- ---------------- SRP Start Request -\u003e kTLVType_State kTLVType_Method SRP6a_server_method() SRP_set_username() with \"Pair‐Setup\" retrieve SRP verifier for the setup code from an EEPROM and SRP_set_authenticator() salt = random() public key = SRP_gen_pub() \u003c-- SRP Start Response kTLVType_State kTLVType_PublicKey kTLVType_Salt \u003c16 byte salt\u003e SRP6a_client_method() SRP_set_username() with \"Pair‐Setup\" SRP_set_params() with salt public key = SRP_gen_pub() shared secret key = SRP_compute_key() proof = SRP_respond() --\u003e SRP Verify Request kTLVType_State kTLVType_PublicKey kTLVType_Proof shared secret key = SRP_compute_key() using public key verify proof with SRP_verify() proof = SRP_respond() MFiProof和Accessory Certificate derive MFiChallenge from shared secret by using HKDF‐SHA‐512. MFiChallengeData = SHA‐256(MFiChallenge) Generate the MFi proof, MFiChallengeData written to the ”Challenge Data” register of the Apple Authentication Coprocessor. Read Accessory Certificate from Apple Authentication Coprocessor. Derive SessionKey from shared secret by using HKDF‐SHA‐512. sub‐TLV kTLVType_Signature kTLVType_Certificate encryptedData, authTag = ChaCha20‐Poly1305(SessionKey, Nonce=”PS‐Msg04”, AAD=, Msg=) \u003c-- SRP Verify Response kTLVType_State kTLVType_Proof kTLVType_EncryptedData Verify proof with SRP_verify() Derive SessionKey from shared secret by using HKDF‐SHA‐512. Verify sub‐TLV’s authTag from encrypted Data. Decrypt sub‐TLV in encryptedData Verify AccessoryCertificate, must be issued by the MFi Sub‐Certificate Authority, chained to the Apple root certificate, and have a class between 0x00 and 0x0A. Derive MFiChallenge from shared secret by using HKDF‐SHA‐512. Verify MFiProof using the public key contained in the Accessory Certificate. Generate Ed25519 long‐term public key, iOSDeviceLTPK, and long‐term secret key, iOSDeviceLTSK. Derive iOSDeviceX from shared secret by using HKDF‐SHA‐512. Concatenate iOSDeviceX with the iOS device’s Pairing Identifier, iOSDevicePairingID,and its long‐term public key, iOSDeviceLTPK. reffered to as iOSDeviceInfo. Generate iOSDeviceSignature by signing iOSDeviceInfo with its long‐term secret key, iOSDeviceLTSK, using Ed25519. sub‐TLV kTLVType_Identifier kTLVType_PublicKey kTLVType_Signature Generate the 16 byte authtag. encryptedData, authTag = ChaCha20‐Poly1305(SessionKey, Nonce=”PS‐Msg05”, AAD=, Msg=) --\u003e Exchange Request kTLVType_State kTLVType_EncryptedData Verify sub‐TLV’s authTag from encrypted Data. Decrypt sub‐TLV in encryptedData. Derive iOSDeviceX from shared secret by using HKDF‐SHA‐512. Concatenate iOSDeviceX with the iOS device’s Pairing Identifier, iOSDevicePairingID, and its long‐term public key, iOSDeviceLTPK. reffered to as iOSDeviceInfo. Use Ed25519 to verify the signature of the constructed iOSDeviceInfo with the iOSDeviceLTPK from the decrypted sub‐TLV. Persistently save the iOSDevicePairingID and iOSDeviceLTPK as a pairing. Generate its Ed25519 long‐term public key, AccessoryLTPK, and long‐term secret key, AccessoryLTSK. Derive AccessoryX from shared secret by using HKDF‐SHA‐512. Concatenate AccessoryX with the accessory’s PairingIdentifier, AccessoryPairingID, and its long‐term public key, AccessoryLTPK. Use Ed25519 to generate AccessorySignature by signing AccessoryInfo with its long‐term secret key, AccessoryLTSK. sub‐TLV kTLVType_Identifier kTLVType_PublicKey kTLVType_Signature Generate the 16 byte authtag. encryptedData, authTag = ChaCha20‐Poly1305(SessionKey, Nonce=”PS‐Msg06”, AAD=, Msg=) \u003c-- Exchange Response kTLVType_State kTLVType_EncryptedData Verify sub‐TLV’s authTag from encrypted Data. Decrypt sub‐TLV in encryptedData. Uses Ed25519 to verify the signature of AccessoryInfo using AccessoryLTPK. Persistently saves AccessoryPairingID and AccessoryLTPK as a pairing. iOS device验证Accessory是MFI认证的 Accessory\n从SRP共享密钥派生MFiChallenge，传给MFI芯片生成MFi proof，从MFI芯片读取Accessory Certificate。 从SRP共享密钥派生SessionKey，用ChaCha20‐Poly1305加密算法使用SessionKey加密MFi proof和Accessory Certificate。 iOS device\n从SRP共享密钥派生SessionKey，用ChaCha20‐Poly1305加密算法使用SessionKey解密得到MFi proof和Accessory Certificate。 验证Accessory Certificate。 从SRP共享密钥派生MFiChallenge，用Accessory Certificate中的public key验证MFi proof。 为什么从SRP共享密钥派生SessionKey，而不直接用SRP共享密钥 派生出SessionKey来进行部分操作，可以增加安全性。即使SessionKey被泄露，攻击者也无法利用这个密钥进行其他操作，因为它只用于特定的步骤。而且，每个SessionKey都是临时的，只用于一次会话，会话结束后就会废弃，这样也能防止长时间使用同一密钥导致的安全风险。\nSRP身份认证和MFI验证结束后，双方交换对方的PairingID、公钥保存下来 加密是为了保护数据的隐私，签名是为了验证数据的完整性和身份验证，防止数据被篡改。\niOS device\nEd25519生成公钥、私钥，从SRP共享密钥派生iOSDeviceX。 用私钥对生成签名。 用ChaCha20‐Poly1305加密算法使用SessionKey加密iOSDevicePairingID、iOSDeviceLTPK、iOSDeviceSignature。 Accessory\n用ChaCha20‐Poly1305加密算法使用SessionKey解密得到iOSDevicePairingID、iOSDeviceLTPK、iOSDeviceSignature。 从SRP共享密钥派生iOSDeviceX，用Ed25519算法验证的签名，使用公钥iOSDeviceLTPK。 Ed25519生成公钥、私钥，从SRP共享密钥派生AccessoryX。 用私钥对生成签名。 用ChaCha20‐Poly1305加密算法使用SessionKey加密AccessoryPairingID、AccessoryLTPK、AccessorySignature。 iOS device\n用ChaCha20‐Poly1305加密算法使用SessionKey解密得到AccessoryPairingID、AccessoryLTPK、AccessorySignature。 从SRP共享密钥派生AccessoryX，用Ed25519算法验证的签名，使用公钥AccessoryLTPK。 参考：\nhttps://en.wikipedia.org/wiki/Secure_Remote_Password_protocol\nhttps://github.com/opencoff/go-srp\nhttp://srp.stanford.edu/ndss.html\nhttps://pythonhosted.org/srp/srp.html\nhttps://docs.espressif.com/projects/esp-idf/zh_CN/v5.1.2/esp32/api-reference/provisioning/provisioning.html\n","wordCount":"1225","inLanguage":"en","datePublished":"2024-04-27T11:16:11+08:00","dateModified":"2024-04-27T11:16:11+08:00","author":{"@type":"Person","name":"Xin"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://examplesite.com/posts/home-kit-paring/"},"publisher":{"@type":"Organization","name":"ExampleSite","logo":{"@type":"ImageObject","url":"https://examplesite.com/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://examplesite.com/ accesskey=h title="Xin's Blog (Alt + H)"><img src="https://img2.baidu.com/it/u=792555388,2449797505&amp;fm=253&amp;fmt=auto&amp;app=138&amp;f=JPEG?w=667&amp;h=500" alt aria-label=logo height=35>Xin's Blog</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://examplesite.com/posts/ title=posts><span>posts</span></a></li><li><a href=https://examplesite.com/leetcode-topics/ title=leetcode专题><span>leetcode专题</span></a></li><li><a href=https://examplesite.com/leetcode-problems/ title=leetcode题解><span>leetcode题解</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://examplesite.com/>Home</a>&nbsp;»&nbsp;<a href=https://examplesite.com/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Home Kit配对协议</h1><div class=post-meta><span title='2024-04-27 11:16:11 +0800 CST'>April 27, 2024</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1225 words&nbsp;·&nbsp;Xin</div></header><div class=toc><details open><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#srp协议>SRP协议</a><ul><li><a href=#约定解释>约定解释</a></li><li><a href=#生成和存储password-verifier>生成和存储Password Verifier</a></li><li><a href=#身份认证过程>身份认证过程</a></li></ul></li><li><a href=#home-kit配对>Home Kit配对</a><ul><li><a href=#配对流程>配对流程</a></li><li><a href=#ios-device验证accessory是mfi认证的>iOS device验证Accessory是MFI认证的</a></li><li><a href=#为什么从srp共享密钥派生sessionkey而不直接用srp共享密钥>为什么从SRP共享密钥派生SessionKey，而不直接用SRP共享密钥</a></li><li><a href=#srp身份认证和mfi验证结束后双方交换对方的pairingid公钥保存下来>SRP身份认证和MFI验证结束后，双方交换对方的PairingID、公钥保存下来</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=srp协议>SRP协议<a hidden class=anchor aria-hidden=true href=#srp协议>#</a></h2><p>SRP 是一种基于密码的相互身份验证的协议，要求双方都知道用户的密码。在身份验证过程中还生成了共享密钥，可通过对称加密来加密报文。</p><h3 id=约定解释>约定解释<a hidden class=anchor aria-hidden=true href=#约定解释>#</a></h3><pre tabindex=0><code>N    A large safe prime (N = 2q+1, where q is prime)，All arithmetic is done modulo N.
g    A generator modulo N
k    Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6)
s    User&#39;s salt
I    Username
p    Cleartext Password
H()  One-way hash function
^    (Modular) Exponentiation
u    Random scrambling parameter
a,b  Secret ephemeral values
A,B  Public ephemeral values
x    Private key (derived from p and s)
v    Password verifier
</code></pre><pre tabindex=0><code>N    安全的大素数，所有的运算都是mod N
g    A generator modulo N
k    Multiplier parameter (k = H(N, g) in SRP-6a, k = 3 for legacy SRP-6)
s    加盐，是一种随机产生的数据，用于保护密码的安全
I    用户名
p    明文密码
H()  单向哈希函数，不可逆
^    模幂运算，即求a^b mod n的值
u    随机混淆参数，用于增加安全性
a,b  秘密临时值，是随机生成的大整数
A,B  公开临时值，用于身份验证的过程中
x    私钥，由密码p和盐值s衍生而来
v    密码验证器，由g^x mod N计算得出，用于在服务器端验证用户的密码
</code></pre><h3 id=生成和存储password-verifier>生成和存储Password Verifier<a hidden class=anchor aria-hidden=true href=#生成和存储password-verifier>#</a></h3><p>通过以下公式生成password verifier，服务端将{I, s, v}存储到数据库，可通过索引键I获取该三元组。</p><pre tabindex=0><code>s = randomsalt()          (same length as N)
I = H(I)
p = H(p)                  (hash/expand I &amp; p)
t = H(I, &#34;:&#34;, p)
x = H(s, t)
v = g^x                   (computes password verifier)
</code></pre><h3 id=身份认证过程>身份认证过程<a hidden class=anchor aria-hidden=true href=#身份认证过程>#</a></h3><pre tabindex=0><code>Client                       Server
--------------               ----------------
un, pw = &lt; user input &gt;
I = H(un)
p = H(pw)
a = random()
A = g^a % N
            I, A --&gt;
                          s, v = lookup(I)
                          b = random()
                          B = (kv + g^b) % N
                          u = H(A, B)
                          S = ((A * v^u) ^ b) % N
                          K = H(S)
                          M&#39; = H(K, A, B, I, s, N, g)
             &lt;-- s, B
u = H(A, B)
x = H(s, p)
S = ((B - k (g^x)) ^ (a + ux)) % N
K = H(S)
M = H(K, A, B, I, s, N, g)

            M --&gt;
                          M must be equal to M&#39;
                          Z = H(M, K)
            &lt;-- Z

Z&#39; = H(M, K)
Z&#39; must equal Z
</code></pre><p>当服务器收到&lt;I, A>，其中I是用户名，A是用户生成的公开临时值，服务器就可以生成共享密钥和生成证明M&rsquo;。共享密钥K的生成需要password verifier。</p><p>生成证明：服务器和客户端都要计算一个值M，这个值是基于用户名、盐值、临时公开值和共享密钥等参数的哈希。服务器计算的值被称为M&rsquo;。服务器通过验证M和M&rsquo;是否相等，验证客户端是否生成和服务器一样的共享密钥，从而验证了客户端的身份，并生成证明Z给客户端，同理客户端通过验证Z和Z&rsquo;是否相等，验证了服务器身份。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;crypto/subtle&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>	<span class=s>&#34;github.com/opencoff/go-srp&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>bits</span> <span class=o>:=</span> <span class=mi>1024</span>
</span></span><span class=line><span class=cl>	<span class=nx>pass</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;password string that&#39;s too long&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>i</span> <span class=o>:=</span> <span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=s>&#34;foouser&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>s</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srp</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=nx>bits</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>v</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>Verifier</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>pass</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>ih</span><span class=p>,</span> <span class=nx>vh</span> <span class=o>:=</span> <span class=nx>v</span><span class=p>.</span><span class=nf>Encode</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Store ih, vh in durable storage
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Verifier Store:\n   %s =&gt; %s\n&#34;</span><span class=p>,</span> <span class=nx>ih</span><span class=p>,</span> <span class=nx>vh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>c</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>NewClient</span><span class=p>(</span><span class=nx>i</span><span class=p>,</span> <span class=nx>pass</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// client credentials (public key and identity) to send to server
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>creds</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Credentials</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Client Begin; &lt;I, A&gt; --&gt; server:\n   %s\n&#34;</span><span class=p>,</span> <span class=nx>creds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Begin the server by parsing the client public key and identity.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ih</span><span class=p>,</span> <span class=nx>A</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>srp</span><span class=p>.</span><span class=nf>ServerBegin</span><span class=p>(</span><span class=nx>creds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Now, pretend to lookup the user db using &#34;I&#34; as the key and
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// fetch salt, verifier etc.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>s</span><span class=p>,</span> <span class=nx>v</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>srp</span><span class=p>.</span><span class=nf>MakeSRPVerifier</span><span class=p>(</span><span class=nx>vh</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Begin; &lt;v, A&gt;:\n   %s\n   %x\n&#34;</span><span class=p>,</span> <span class=nx>vh</span><span class=p>,</span> <span class=nx>A</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>srv</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>s</span><span class=p>.</span><span class=nf>NewServer</span><span class=p>(</span><span class=nx>v</span><span class=p>,</span> <span class=nx>A</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Generate the credentials to send to client
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>creds</span> <span class=p>=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>Credentials</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Send the server public key and salt to server
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Begin; &lt;s, B&gt; --&gt; client:\n   %s\n&#34;</span><span class=p>,</span> <span class=nx>creds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// client processes the server creds and generates
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// a mutual authenticator; the authenticator is sent
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to the server as proof that the client derived its keys.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>cauth</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>Generate</span><span class=p>(</span><span class=nx>creds</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Client Authenticator: M --&gt; Server\n   %s\n&#34;</span><span class=p>,</span> <span class=nx>cauth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Receive the proof of authentication from client
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>proof</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>ClientOk</span><span class=p>(</span><span class=nx>cauth</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;client auth failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Send proof to the client
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Server Authenticator: Z --&gt; Client\n   %s\n&#34;</span><span class=p>,</span> <span class=nx>proof</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Verify the server&#39;s proof
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>c</span><span class=p>.</span><span class=nf>ServerOk</span><span class=p>(</span><span class=nx>proof</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;server auth failed&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Now, we have successfully authenticated the client to the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// server and vice versa.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>kc</span> <span class=o>:=</span> <span class=nx>c</span><span class=p>.</span><span class=nf>RawKey</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ks</span> <span class=o>:=</span> <span class=nx>srv</span><span class=p>.</span><span class=nf>RawKey</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=mi>1</span> <span class=o>!=</span> <span class=nx>subtle</span><span class=p>.</span><span class=nf>ConstantTimeCompare</span><span class=p>(</span><span class=nx>kc</span><span class=p>,</span> <span class=nx>ks</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=s>&#34;Keys are different!&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Client Key: %x\nServer Key: %x\n&#34;</span><span class=p>,</span> <span class=nx>kc</span><span class=p>,</span> <span class=nx>ks</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>a</p><pre tabindex=0><code>Verifier Store:
   b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8 =&gt; 128:eeaf0ab9adb38dd69c33f80afa8fc5e86072618775ff3c0b9ea2314c9c256576d674df7496ea81d3383b4813d692c6e0e0d5d8e250b98be48e495c1d6089dad15dc7d7b46154d6b6ce8ef4ad69b15d4982559b297bcf1885c529f566660e57ec68edbc3c05726cc02fd4cbf4976eaa9afd5138fe8376435b9fc61d2fc0eb06e3:2:17:b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8:19a5dd80011dc63a3dfda1c742d55399c009617987868a6951ea91d754d7d9519a3c4801ec0da71eb4ae1cf3f0f97c857954a4d8f54729170512312819c790296b12c84c28bbe270f542c89c6446591373d3fea8ff445a51cefe85d002ce32e1fb003c5533d6b97f1464680c88afd4cc9e15ce15163a410be44b1af9c5e08265:a7d956665ae1415b380db321bcca75f013bda5ea347489318d2c967d1b69e4115c54022225e67e5008fdfcf0841feeb5a0e26fabdb6f0e05b3fc9f96f6b830ab1599ae1b22cbc31cd9b667b48ef0a33d580e43999b2299c8acb0ec761cb72558cf2cf8a7bad78a5b5bbb8a2c473d2f93e13975618b54a431a38344d779ddb7e6
Client Begin; &lt;I, A&gt; --&gt; server:
   b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8:1588ca95bcc97f38c88f5cc942712e27867e71f7e33c25d53e17142170152d0f03420a3d17f23e9451c335b713bb5143bc7c8f398239a923dacf5d186dd49902e01e6bd7fb14c46d0d41d0e328711e3182b2d86ccd9151db6555bbdd9aa5f5e7df655d3c910c1e2d3527463b4b5932693291eae189446416534b1afe77773916
Server Begin; &lt;v, A&gt;:
   128:eeaf0ab9adb38dd69c33f80afa8fc5e86072618775ff3c0b9ea2314c9c256576d674df7496ea81d3383b4813d692c6e0e0d5d8e250b98be48e495c1d6089dad15dc7d7b46154d6b6ce8ef4ad69b15d4982559b297bcf1885c529f566660e57ec68edbc3c05726cc02fd4cbf4976eaa9afd5138fe8376435b9fc61d2fc0eb06e3:2:17:b8fd39a36525c3a6aa40660f6093b2ae5024d23dcd1d9da9421ad53989fb07f8:19a5dd80011dc63a3dfda1c742d55399c009617987868a6951ea91d754d7d9519a3c4801ec0da71eb4ae1cf3f0f97c857954a4d8f54729170512312819c790296b12c84c28bbe270f542c89c6446591373d3fea8ff445a51cefe85d002ce32e1fb003c5533d6b97f1464680c88afd4cc9e15ce15163a410be44b1af9c5e08265:a7d956665ae1415b380db321bcca75f013bda5ea347489318d2c967d1b69e4115c54022225e67e5008fdfcf0841feeb5a0e26fabdb6f0e05b3fc9f96f6b830ab1599ae1b22cbc31cd9b667b48ef0a33d580e43999b2299c8acb0ec761cb72558cf2cf8a7bad78a5b5bbb8a2c473d2f93e13975618b54a431a38344d779ddb7e6
   1588ca95bcc97f38c88f5cc942712e27867e71f7e33c25d53e17142170152d0f03420a3d17f23e9451c335b713bb5143bc7c8f398239a923dacf5d186dd49902e01e6bd7fb14c46d0d41d0e328711e3182b2d86ccd9151db6555bbdd9aa5f5e7df655d3c910c1e2d3527463b4b5932693291eae189446416534b1afe77773916
Server Begin; &lt;s, B&gt; --&gt; client:
   19a5dd80011dc63a3dfda1c742d55399c009617987868a6951ea91d754d7d9519a3c4801ec0da71eb4ae1cf3f0f97c857954a4d8f54729170512312819c790296b12c84c28bbe270f542c89c6446591373d3fea8ff445a51cefe85d002ce32e1fb003c5533d6b97f1464680c88afd4cc9e15ce15163a410be44b1af9c5e08265:c19dda117838c7635838cfb9fe6a989f7b897a28b37a931fb1705a0e2dc2c81f2b6848a0e729522328cb273ed1abc676f4edb46a113ea9f8933088ffa59682115c4a945ee199516f5f239bfb7df2bcde6b9d704079cd5144bc4adfbaec472995c36f93cdebf24b7e3dc0cfcb21888921e0582fec28da77e07c0dfc7b7ebb57ad
Client Authenticator: M --&gt; Server
   201592da93ce191af56559836f9fa3960016f0b137b2bde4164692febb9fcdaf
Server Authenticator: Z --&gt; Client
   cdb200ca5280baedff73efb4b4078b411bd6caf4b0456793b2a489ee16cbc2aa
Client Key: a13788fbd82def1995bf1057b32d6ea2c31a25ce056c1edb3bf766ce18ac09d6
Server Key: a13788fbd82def1995bf1057b32d6ea2c31a25ce056c1edb3bf766ce18ac09d6
</code></pre><p><img loading=lazy src=https://docs.espressif.com/projects/esp-idf/zh_CN/v5.1.2/esp32/_images/seqdiag-5054c1e6eebf7b8d04573fcd01575dcd936db1b5.png alt=https://docs.espressif.com/projects/esp-idf/zh_CN/v5.1.2/esp32/_images/seqdiag-5054c1e6eebf7b8d04573fcd01575dcd936db1b5.png></p><h2 id=home-kit配对>Home Kit配对<a hidden class=anchor aria-hidden=true href=#home-kit配对>#</a></h2><p>home kit配对使用SRP协议，username和password为“Pair‐Setup”和setup code。</p><h3 id=配对流程>配对流程<a hidden class=anchor aria-hidden=true href=#配对流程>#</a></h3><pre tabindex=0><code>iOS device/srp client                                                Accessory/srp server
--------------                                                       ----------------
           			  SRP Start Request -&gt;
           			  kTLVType_State &lt;M1&gt;
           			  kTLVType_Method &lt;Pair Setup with Authentication&gt;
                                                                     SRP6a_server_method()
                                                                     SRP_set_username() with &#34;Pair‐Setup&#34;
                                                                     retrieve SRP verifier for the setup code
                                                                     from an EEPROM and SRP_set_authenticator()
                                                                     salt = random()
                                                                     public key = SRP_gen_pub()
           			  &lt;-- SRP Start Response
           			  kTLVType_State &lt;M2&gt;
           			  kTLVType_PublicKey &lt;Accessory’s SRP public key&gt;
           			  kTLVType_Salt &lt;16 byte salt&gt;
                  
SRP6a_client_method()
SRP_set_username() with &#34;Pair‐Setup&#34;
SRP_set_params() with salt
public key = SRP_gen_pub()
shared secret key = SRP_compute_key()
proof = SRP_respond()

           			  --&gt; SRP Verify Request
           			  kTLVType_State &lt;M3&gt;
           			  kTLVType_PublicKey &lt;iOS device’s SRP public key&gt;
           			  kTLVType_Proof &lt;iOS device’s SRP proof&gt;
                                                                    shared secret key = SRP_compute_key() using
                                                                    public key
                                                                    verify proof with SRP_verify()
                                                                    proof = SRP_respond()
                                                                    
                                                                    MFiProof和Accessory Certificate
                                                                    derive MFiChallenge from shared secret by 
                                                                    using HKDF‐SHA‐512.
                                                                    MFiChallengeData = SHA‐256(MFiChallenge)
                                                                    Generate the MFi proof, MFiChallengeData 
                                                                    written to the ”Challenge Data” register of 
                                                                    the Apple Authentication Coprocessor.
                                                                    Read Accessory Certificate from Apple 
                                                                    Authentication Coprocessor.
                                                                    Derive SessionKey from shared secret by 
                                                                    using HKDF‐SHA‐512.
                                                                    sub‐TLV
                                                                    kTLVType_Signature &lt;MFiProof&gt; 
                                                                    kTLVType_Certificate &lt;AccessoryCertificate&gt;
                                                                    encryptedData, authTag = 
                                                                    ChaCha20‐Poly1305(SessionKey, 
                                                                    Nonce=”PS‐Msg04”, AAD=&lt;none&gt;, Msg=&lt;Sub‐TLV&gt;)
           			  &lt;-- SRP Verify Response                    
           			  kTLVType_State &lt;M4&gt;
           			  kTLVType_Proof &lt;Accessory’s SRP proof&gt;
           			  kTLVType_EncryptedData &lt;encryptedData with authTag appended&gt;
                  
Verify proof with SRP_verify()
Derive SessionKey from shared secret by using HKDF‐SHA‐512.
Verify sub‐TLV’s authTag from encrypted Data.
Decrypt sub‐TLV in encryptedData
Verify AccessoryCertificate, must be issued by the MFi Sub‐Certificate Authority, chained to the Apple root certificate, and have a class between 0x00 and 0x0A.
Derive MFiChallenge from shared secret by using HKDF‐SHA‐512.
Verify MFiProof using the public key contained in the Accessory Certificate.

Generate Ed25519 long‐term public key, iOSDeviceLTPK, and long‐term secret key, iOSDeviceLTSK.
Derive iOSDeviceX from shared secret by using HKDF‐SHA‐512.
Concatenate iOSDeviceX with the iOS device’s Pairing Identifier, iOSDevicePairingID,and its long‐term public key, iOSDeviceLTPK. reffered to as iOSDeviceInfo.
Generate iOSDeviceSignature by signing iOSDeviceInfo with its long‐term secret key, iOSDeviceLTSK, using Ed25519.
sub‐TLV
kTLVType_Identifier &lt;iOSDevicePairingID&gt;
kTLVType_PublicKey &lt;iOSDeviceLTPK&gt;
kTLVType_Signature &lt;iOSDeviceSignature&gt;
Generate the 16 byte authtag.
encryptedData, authTag = ChaCha20‐Poly1305(SessionKey, Nonce=”PS‐Msg05”, AAD=&lt;none&gt;, Msg=&lt;Sub‐TLV&gt;)

           			  --&gt; Exchange Request
           			  kTLVType_State &lt;M5&gt;
           			  kTLVType_EncryptedData &lt;encryptedData with authTag appended&gt;
                                                                    Verify sub‐TLV’s authTag from encrypted 
                                                                    Data.
                                                                    Decrypt sub‐TLV in encryptedData.
                                                                    Derive iOSDeviceX from shared secret by 
                                                                    using HKDF‐SHA‐512.
                                                                    Concatenate iOSDeviceX with the iOS device’s 
                                                                    Pairing Identifier, iOSDevicePairingID, and 
                                                                    its long‐term public key, iOSDeviceLTPK. 
                                                                    reffered to as iOSDeviceInfo.
                                                                    Use Ed25519 to verify the signature of the 
                                                                    constructed iOSDeviceInfo with the
                                                                    iOSDeviceLTPK from the decrypted sub‐TLV.
                                                                    Persistently save the iOSDevicePairingID and 
                                                                    iOSDeviceLTPK as a pairing.
                                                                    
                                                                    Generate its Ed25519 long‐term public key, 
                                                                    AccessoryLTPK, and long‐term secret key, 
                                                                    AccessoryLTSK.
                                                                    Derive AccessoryX from  shared secret by 
                                                                    using HKDF‐SHA‐512.
                                                                    Concatenate AccessoryX with the accessory’s 
                                                                    PairingIdentifier, AccessoryPairingID, and 
                                                                    its long‐term public key, AccessoryLTPK. 
                                                                    Use Ed25519 to generate AccessorySignature 
                                                                    by signing AccessoryInfo with its long‐term 
                                                                    secret key, AccessoryLTSK.
                                                                    sub‐TLV
                                                                    kTLVType_Identifier &lt;AccessoryPairingID&gt;
                                                                    kTLVType_PublicKey &lt;AccessoryLTPK&gt;
                                                                    kTLVType_Signature &lt;AccessorySignature&gt;
                                                                    Generate the 16 byte authtag.
                                                                    encryptedData, authTag = 
                                                                    ChaCha20‐Poly1305(SessionKey, 
                                                                    Nonce=”PS‐Msg06”, AAD=&lt;none&gt;, Msg=&lt;Sub‐TLV&gt;)
           			  &lt;-- Exchange Response          
           			  kTLVType_State &lt;M6&gt;
           			  kTLVType_EncryptedData &lt;encryptedData with authTag appended&gt;
Verify sub‐TLV’s authTag from encrypted Data.
Decrypt sub‐TLV in encryptedData.
Uses Ed25519 to verify the signature of AccessoryInfo using AccessoryLTPK.
Persistently saves AccessoryPairingID and AccessoryLTPK as a pairing.
</code></pre><h3 id=ios-device验证accessory是mfi认证的>iOS device验证Accessory是MFI认证的<a hidden class=anchor aria-hidden=true href=#ios-device验证accessory是mfi认证的>#</a></h3><p>Accessory</p><ol><li>从SRP共享密钥派生MFiChallenge，传给MFI芯片生成MFi proof，从MFI芯片读取Accessory Certificate。</li><li>从SRP共享密钥派生SessionKey，用ChaCha20‐Poly1305加密算法使用SessionKey加密MFi proof和Accessory Certificate。</li></ol><p>iOS device</p><ol><li>从SRP共享密钥派生SessionKey，用ChaCha20‐Poly1305加密算法使用SessionKey解密得到MFi proof和Accessory Certificate。</li><li>验证Accessory Certificate。</li><li>从SRP共享密钥派生MFiChallenge，用Accessory Certificate中的public key验证MFi proof。</li></ol><h3 id=为什么从srp共享密钥派生sessionkey而不直接用srp共享密钥>为什么从SRP共享密钥派生SessionKey，而不直接用SRP共享密钥<a hidden class=anchor aria-hidden=true href=#为什么从srp共享密钥派生sessionkey而不直接用srp共享密钥>#</a></h3><p>派生出SessionKey来进行部分操作，可以增加安全性。即使SessionKey被泄露，攻击者也无法利用这个密钥进行其他操作，因为它只用于特定的步骤。而且，每个SessionKey都是临时的，只用于一次会话，会话结束后就会废弃，这样也能防止长时间使用同一密钥导致的安全风险。</p><h3 id=srp身份认证和mfi验证结束后双方交换对方的pairingid公钥保存下来>SRP身份认证和MFI验证结束后，双方交换对方的PairingID、公钥保存下来<a hidden class=anchor aria-hidden=true href=#srp身份认证和mfi验证结束后双方交换对方的pairingid公钥保存下来>#</a></h3><p>加密是为了保护数据的隐私，签名是为了验证数据的完整性和身份验证，防止数据被篡改。</p><p>iOS device</p><ol><li>Ed25519生成公钥、私钥，从SRP共享密钥派生iOSDeviceX。</li><li>用私钥对&lt;iOSDeviceX + iOSDevicePairingID + 公钥>生成签名。</li><li>用ChaCha20‐Poly1305加密算法使用SessionKey加密iOSDevicePairingID、iOSDeviceLTPK、iOSDeviceSignature。</li></ol><p>Accessory</p><ol><li>用ChaCha20‐Poly1305加密算法使用SessionKey解密得到iOSDevicePairingID、iOSDeviceLTPK、iOSDeviceSignature。</li><li>从SRP共享密钥派生iOSDeviceX，用Ed25519算法验证&lt;iOSDeviceX + iOSDevicePairingID + 公钥>的签名，使用公钥iOSDeviceLTPK。</li><li>Ed25519生成公钥、私钥，从SRP共享密钥派生AccessoryX。</li><li>用私钥对&lt;AccessoryX + AccessoryPairingID + 公钥>生成签名。</li><li>用ChaCha20‐Poly1305加密算法使用SessionKey加密AccessoryPairingID、AccessoryLTPK、AccessorySignature。</li></ol><p>iOS device</p><ol><li>用ChaCha20‐Poly1305加密算法使用SessionKey解密得到AccessoryPairingID、AccessoryLTPK、AccessorySignature。</li><li>从SRP共享密钥派生AccessoryX，用Ed25519算法验证&lt;AccessoryX + AccessoryPairingID + 公钥>的签名，使用公钥AccessoryLTPK。</li></ol><p>参考：</p><p><a href=https://en.wikipedia.org/wiki/Secure_Remote_Password_protocol>https://en.wikipedia.org/wiki/Secure_Remote_Password_protocol</a></p><p><a href=https://github.com/opencoff/go-srp>https://github.com/opencoff/go-srp</a></p><p><a href=http://srp.stanford.edu/ndss.html>http://srp.stanford.edu/ndss.html</a></p><p><a href=https://pythonhosted.org/srp/srp.html>https://pythonhosted.org/srp/srp.html</a></p><p><a href=https://docs.espressif.com/projects/esp-idf/zh_CN/v5.1.2/esp32/api-reference/provisioning/provisioning.html>https://docs.espressif.com/projects/esp-idf/zh_CN/v5.1.2/esp32/api-reference/provisioning/provisioning.html</a></p></div><footer class=post-footer><ul class=post-tags></ul><ul class=share-buttons><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on x" href="https://x.com/intent/tweet/?text=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae&amp;url=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f&amp;hashtags="><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446C483.971.0 512 28.03 512 62.554zM269.951 190.75 182.567 75.216H56L207.216 272.95 63.9 436.783h61.366L235.9 310.383l96.667 126.4H456L298.367 228.367l134-153.151H371.033zM127.633 110h36.468l219.38 290.065H349.5z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on linkedin" href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f&amp;title=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae&amp;summary=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae&amp;source=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM160.461 423.278V197.561h-75.04v225.717h75.04zm270.539.0V293.839c0-69.333-37.018-101.586-86.381-101.586-39.804.0-57.634 21.891-67.617 37.266v-31.958h-75.021c.995 21.181.0 225.717.0 225.717h75.02V297.222c0-6.748.486-13.492 2.474-18.315 5.414-13.475 17.767-27.434 38.494-27.434 27.135.0 38.007 20.707 38.007 51.037v120.768H431zM123.448 88.722C97.774 88.722 81 105.601 81 127.724c0 21.658 16.264 39.002 41.455 39.002h.484c26.165.0 42.452-17.344 42.452-39.002-.485-22.092-16.241-38.954-41.943-39.002z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on reddit" href="https://reddit.com/submit?url=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f&title=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zM446 265.638c0-22.964-18.616-41.58-41.58-41.58-11.211.0-21.361 4.457-28.841 11.666-28.424-20.508-67.586-33.757-111.204-35.278l18.941-89.121 61.884 13.157c.756 15.734 13.642 28.29 29.56 28.29 16.407.0 29.706-13.299 29.706-29.701.0-16.403-13.299-29.702-29.706-29.702-11.666.0-21.657 6.792-26.515 16.578l-69.105-14.69c-1.922-.418-3.939-.042-5.585 1.036-1.658 1.073-2.811 2.761-3.224 4.686l-21.152 99.438c-44.258 1.228-84.046 14.494-112.837 35.232-7.468-7.164-17.589-11.591-28.757-11.591-22.965.0-41.585 18.616-41.585 41.58.0 16.896 10.095 31.41 24.568 37.918-.639 4.135-.99 8.328-.99 12.576.0 63.977 74.469 115.836 166.33 115.836s166.334-51.859 166.334-115.836c0-4.218-.347-8.387-.977-12.493 14.564-6.47 24.735-21.034 24.735-38.001zM326.526 373.831c-20.27 20.241-59.115 21.816-70.534 21.816-11.428.0-50.277-1.575-70.522-21.82-3.007-3.008-3.007-7.882.0-10.889 3.003-2.999 7.882-3.003 10.885.0 12.777 12.781 40.11 17.317 59.637 17.317 19.522.0 46.86-4.536 59.657-17.321 3.016-2.999 7.886-2.995 10.885.008 3.008 3.011 3.003 7.882-.008 10.889zm-5.23-48.781c-16.373.0-29.701-13.324-29.701-29.698.0-16.381 13.328-29.714 29.701-29.714 16.378.0 29.706 13.333 29.706 29.714.0 16.374-13.328 29.698-29.706 29.698zM160.91 295.348c0-16.381 13.328-29.71 29.714-29.71 16.369.0 29.689 13.329 29.689 29.71.0 16.373-13.32 29.693-29.689 29.693-16.386.0-29.714-13.32-29.714-29.693z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on facebook" href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H342.978V319.085h66.6l12.672-82.621h-79.272v-53.617c0-22.603 11.073-44.636 46.58-44.636H425.6v-70.34s-32.71-5.582-63.982-5.582c-65.288.0-107.96 39.569-107.96 111.204v62.971h-72.573v82.621h72.573V512h-191.104c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on whatsapp" href="https://api.whatsapp.com/send?text=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae%20-%20https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f"><svg viewBox="0 0 512 512" height="30" width="30" fill="currentcolor"><path d="M449.446.0C483.971.0 512 28.03 512 62.554v386.892C512 483.97 483.97 512 449.446 512H62.554c-34.524.0-62.554-28.03-62.554-62.554V62.554c0-34.524 28.029-62.554 62.554-62.554h386.892zm-58.673 127.703c-33.842-33.881-78.847-52.548-126.798-52.568-98.799.0-179.21 80.405-179.249 179.234-.013 31.593 8.241 62.428 23.927 89.612l-25.429 92.884 95.021-24.925c26.181 14.28 55.659 21.807 85.658 21.816h.074c98.789.0 179.206-80.413 179.247-179.243.018-47.895-18.61-92.93-52.451-126.81zM263.976 403.485h-.06c-26.734-.01-52.954-7.193-75.828-20.767l-5.441-3.229-56.386 14.792 15.05-54.977-3.542-5.637c-14.913-23.72-22.791-51.136-22.779-79.287.033-82.142 66.867-148.971 149.046-148.971 39.793.014 77.199 15.531 105.329 43.692 28.128 28.16 43.609 65.592 43.594 105.4-.034 82.149-66.866 148.983-148.983 148.984zm81.721-111.581c-4.479-2.242-26.499-13.075-30.604-14.571-4.105-1.495-7.091-2.241-10.077 2.241-2.986 4.483-11.569 14.572-14.182 17.562-2.612 2.988-5.225 3.364-9.703 1.12-4.479-2.241-18.91-6.97-36.017-22.23C231.8 264.15 222.81 249.484 220.198 245s-.279-6.908 1.963-9.14c2.016-2.007 4.48-5.232 6.719-7.847 2.24-2.615 2.986-4.484 4.479-7.472 1.493-2.99.747-5.604-.374-7.846-1.119-2.241-10.077-24.288-13.809-33.256-3.635-8.733-7.327-7.55-10.077-7.688-2.609-.13-5.598-.158-8.583-.158-2.986.0-7.839 1.121-11.944 5.604-4.105 4.484-15.675 15.32-15.675 37.364.0 22.046 16.048 43.342 18.287 46.332 2.24 2.99 31.582 48.227 76.511 67.627 10.685 4.615 19.028 7.371 25.533 9.434 10.728 3.41 20.492 2.929 28.209 1.775 8.605-1.285 26.499-10.833 30.231-21.295 3.732-10.464 3.732-19.431 2.612-21.298-1.119-1.869-4.105-2.99-8.583-5.232z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on telegram" href="https://telegram.me/share/url?text=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae&amp;url=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f"><svg viewBox="2 2 28 28" height="30" width="30" fill="currentcolor"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg></a></li><li><a target=_blank rel="noopener noreferrer" aria-label="share Home Kit配对协议 on ycombinator" href="https://news.ycombinator.com/submitlink?t=Home%20Kit%e9%85%8d%e5%af%b9%e5%8d%8f%e8%ae%ae&u=https%3a%2f%2fexamplesite.com%2fposts%2fhome-kit-paring%2f"><svg width="30" height="30" viewBox="0 0 512 512" fill="currentcolor" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"><path d="M449.446.0C483.971.0 512 28.03 512 62.554V449.446C512 483.97 483.97 512 449.446 512H62.554C28.03 512 0 483.97.0 449.446V62.554C0 28.03 28.029.0 62.554.0H449.446zM183.8767 87.9921h-62.034L230.6673 292.4508V424.0079h50.6655V292.4508L390.1575 87.9921H328.1233L256 238.2489z"/></svg></a></li></ul></footer></article></main><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>